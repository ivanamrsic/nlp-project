//
//  ProfilePresenter.swift
//  SentimentClassifier
//
//  Created by Ivana MrÅ¡iÄ‡ on 26.12.2020..
//  Copyright (c) 2020 ___ORGANIZATIONNAME___. All rights reserved.
//
//  This file was generated by the ðŸ VIPER generator
//

import UIKit
import RxSwift
import RxCocoa

final class ProfilePresenter {

    // MARK: - Private properties

    private unowned let view: ProfileViewInterface
    private let interactor: ProfileInteractorInterface
    private let wireframe: ProfileWireframeInterface

    private let disposeBag = DisposeBag()

    // MARK: - Lifecycle

    init(view: ProfileViewInterface, interactor: ProfileInteractorInterface, wireframe: ProfileWireframeInterface) {
        self.view = view
        self.interactor = interactor
        self.wireframe = wireframe
    }
}

// MARK: - ProfilePresenterInterface

extension ProfilePresenter: ProfilePresenterInterface {

    func configure(with output: Profile.ViewOutput) -> Profile.ViewInput {
        handle(choosePhoto: output.choosePhotoAction)
        let refresh = handle(createReview: output.createReviewAction)

        let items = createItems(with: Signal.merge(refresh, output.viewWillAppear))

        return Profile.ViewInput(
            items: items,
            image: interactor.profilePhoto,
            reviewCount: items.map { $0.count }
        )
    }
}

// MARK: - Binding Setup

private extension ProfilePresenter {

    func handle(choosePhoto: Signal<Void>) {
        choosePhoto.emit(onNext: { [unowned wireframe] in
                wireframe.openChoosePhoto()
            })
            .disposed(by: disposeBag)
    }

    func handle(createReview: Signal<Void>) -> Signal<Void> {
        return createReview.flatMap { [unowned wireframe] in wireframe.openCreateReview() }
    }
}

// MARK: - Item creation

private extension ProfilePresenter {

    func createItems(with refresh: Signal<Void>) -> Driver<[TableCellItem]> {
        return refresh.flatMap { [unowned interactor] in
                interactor.fetchReviews().asDriver(onErrorDriveWith: .empty())
            }
            .asDriver(onErrorDriveWith: .empty())
            .map { $0.map { review in ReviewTableCellItem(review: review) } }
    }
}
